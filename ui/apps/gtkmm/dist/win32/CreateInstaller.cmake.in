if (POLICY CMP0011)
  cmake_policy(SET CMP0011 NEW)
endif()
if (POLICY CMP0012)
  cmake_policy(SET CMP0012 NEW)
endif()

# TODO: Duplicate information.
list(APPEND CMAKE_MODULE_PATH "@CMAKE_SOURCE_DIR@/build/cmake/modules")
string(REPLACE "/" "\\" INSTALLDIR ${CMAKE_INSTALL_PREFIX})

message(STATUS "Resolving dependencies. This may take a while")
set(CMAKE_OBJDUMP @CMAKE_OBJDUMP@)
include(Win32ResolveDependencies)
resolve_dependencies("@CMAKE_CURRENT_BINARY_DIR@/../../src/workrave.exe" dependencies resolved_dependencies @SYS_ROOT@/bin)

# TODO: Add dependencies for all installed plugins

set(LIBS_ISS "@CMAKE_CURRENT_BINARY_DIR@/libraries.iss")
file(WRITE ${LIBS_ISS} "; Resolved from Workrave.exe\n")
foreach(dependency ${resolved_dependencies})
  get_filename_component(file ${dependency} NAME)
  file (INSTALL ${dependency} DESTINATION "@CMAKE_INSTALL_PREFIX@/lib")
  file(APPEND ${LIBS_ISS} "Source: \"${INSTALLDIR}\\lib\\${file}\"; DestDir: \"{app}\\lib\"; Flags: ignoreversion;\n")
endforeach()

file(APPEND ${LIBS_ISS} "; 64 bit\n")
file(GLOB FILES64BIT "@CMAKE_INSTALL_PREFIX@/lib64/*.*")
foreach(file ${FILES64BIT})
  get_filename_component(file ${file} NAME)
  set(flags "ignoreversion restartreplace uninsrestartdelete 64bit")
  if (${file} MATCHES "applet.*\\.dll$")
    set(flags "${flags} regserver")
  endif()
  file(APPEND ${LIBS_ISS} "Source: \"${INSTALLDIR}\\lib64\\${file}\"; DestDir: \"{app}\\lib64\"; Check: IsWin64; Flags: ${flags};\n")
endforeach()

if (@CMAKE_CROSSCOMPILING@)
  execute_process(
    COMMAND "@WINE@" "@ISCC@" "/o@CMAKE_INSTALL_PREFIX@" setup.iss
    OUTPUT_VARIABLE out
    RESULT_VARIABLE ret
    OUTPUT_STRIP_TRAILING_WHITESPACE
    WORKING_DIRECTORY "@CMAKE_CURRENT_BINARY_DIR@"
    )
else()
  execute_process(
    COMMAND "@ISCC@" "/o@CMAKE_INSTALL_PREFIX@" setup.iss
    OUTPUT_VARIABLE out
    RESULT_VARIABLE ret
    OUTPUT_STRIP_TRAILING_WHITESPACE
    WORKING_DIRECTORY "@CMAKE_CURRENT_BINARY_DIR@"
    )
endif()

if (NOT "${ret}" STREQUAL "0")
   message(FATAL_ERROR "ISCC failed")
endif()

message("Setup: ${out}")
